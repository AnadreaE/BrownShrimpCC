#Filter only spring data simulation:
check_OF$dateTime <- as.POSIXct(check_OF$dateTime)
check_OF_spring = check_OF %>%
filter(month(dateTime) %in% 3:5) %>%
mutate(date = as.Date(dateTime)) %>%           # Extract date only
group_by(date) %>%                             # Group by just the date
summarise(across(where(is.numeric), \(x) mean(x, na.rm = TRUE)))
#HERE SIMULATIONS WITH NEW K-FUNC tpc FLEXBRIERE
library(ggplot2)
library(deSolve)
library(RColorBrewer)
library(BrownShrimp)
library(viridis)
library(dplyr)
library(tidyr)
library("colorspace")
#library(devtools)
#UPLOAD TEMPERATURE DATA
temperature_dataSet <- read.csv("./data/Temperature_data_1982-2018_MarBiol.csv", header = TRUE, sep = ';')
temperature_10_11 <- temperature_func(temperature_dataSet, "01/01/2010", "31/12/2011")
temperature_10_14 <- temperature_func(temperature_dataSet, "01/01/2010", "31/12/2014")
######### START ###########
state2 <- c(P = 2, E = 0.1, L= 0.4 ,
J_f = .175*0.5 , J2_f = 0.125*0.5, J3_f = 0.125*0.5, J4_f = 0.1*0.5, J5_f = 0.1*0.5,
J_m = .175*0.5 , J2_m = 0.125*0.5, J3_m = 0.125*0.5, J4_m = 0.1*0.5, J5_m = 0.1*0.5,
A1_f = 0.25*0.5, A1_m = 0.25*0.5,
A2 = 0.1, A3=0.1) #males doesn't reach this size classes
#following has been adapted according to references found for some life stages in literature:
#has dimention [kg/ 1000m2]
state_rev1 = c(P = 2, E = 0.1, L= 0.0928 *1.5 ,
J_f = 2, J2_f = 2, J3_f = 2 , J4_f = 1.8, J5_f = 1.8,
J_m = 2 , J2_m = 2, J3_m = 2, J4_m = 1.8, J5_m = 1.8,
A1_f = 5.443*0.5, A1_m = 5.443*0.5,
A2 = 5.443*0.375, A3=5.443*0.125) #males doesn't reach this size classes
#Ref: Larv: 0.0928 kg/1000m2 but lets say that wihtout predation this is 50% bigger
#Ref Fem: 5.443 kg/1000m2 has to be distributed over the 3 Fem adult size classes: we know that A1 > A2 > A3 in biomass
#therefore lets consider following ratio: A1: 0.5, A2: 0.375, A3: 0.125
#since numbers are bigger now, increase juveniles
t = seq(0,length(temperature_10_11$temperature)-0.1, by = 0.1)
t_5years = seq(0,length(temperature_10_14$temperature)-0.1, by = 0.1)
parameters = parameters_solv
#Test with state2
#start <- Sys.time()
#test_sex.v2 <- solver_sizeClass_sex.v2(t = t_5years, state = state2, parameters = parameters, temperature_dataSet = temperature_10_14)
#print(Sys.time() - start)
#TEST WITH state_rev1
#Test with state2
temperature_14_18 <- temperature_func(temperature_dataSet, "01/01/2014", "31/12/2018")
start <- Sys.time()
test_sex.v2 <- solver_sizeClass_sex.v2(t = t_5years, state = state_rev1, parameters = parameters, temperature_dataSet = temperature_14_18)
print(Sys.time() - start)
M_F_2015 = test_sex.v2 %>%
filter( as.Date(dateTime) > as.Date("31/12/2014", format= "%d/%m/%Y" ) & as.Date(dateTime) < as.Date("01/01/2016", format= "%d/%m/%Y" )  ) %>%
select(E, L, J_f, J2_f, J3_f, J4_f, J5_f, A1_f, J_m, J2_m, J3_m, J4_m, J5_m, A1_m, A2, A3)
View(test_sex.v2)
start_date <- as.POSIXct("2014-01-01", format="%Y-%m-%d", tz = "UTC")
test_sex.v2 <- mutate(test_sex.v2, dateTime = start_date + test_sex.v2$time * 86400) #86400 seconds in one day
test_sex.v2 <- test_sex.v2[ , -1] # delete timesteps column
View(test_sex.v2)
M_F_2015 = test_sex.v2 %>%
filter( as.Date(dateTime) > as.Date("31/12/2014", format= "%d/%m/%Y" ) & as.Date(dateTime) < as.Date("01/01/2016", format= "%d/%m/%Y" )  ) %>%
select(E, L, J_f, J2_f, J3_f, J4_f, J5_f, A1_f, J_m, J2_m, J3_m, J4_m, J5_m, A1_m, A2, A3)
# Loop through 4 quarters
par(mfrow = c(2, 2))
# Define colors for each sex: f = light blue, m = steel blue, U = gray
cols <- c("f" = "#8856a7", "m" = "#add8e6", "U" = "gray80")
# Define x-axis label order (class names)
x_labels_vec <- c("E", "L", "J", "J2", "J3", "J4", "J5", "A1", "A2", "A3")
width_vector_all <- rep(1, length(x_labels_vec))  # Optional bar widths
# Loop through 4 quarters
for (q in 1:4) {
# Indices for each quarter
init_idx <- 912 * (q - 1) + 1
final_idx <- 912 * q
# Subset data for quarter
quarter_data <- M_F_2015[init_idx:final_idx, ]
# 1. Get sexed class columns (e.g., J_f, J2_m, A1_f, etc.)
sexed_df <- quarter_data %>%
select(matches("^(J|A1)\\d?_f$|^(J|A1)\\d?_m$"))
# 2. Get unsexed class columns: E and L
unsexed_df <- quarter_data %>%
select(E, L, A2, A3)
# 3. Compute column means
sexed_means <- colMeans(sexed_df)
unsexed_means <- colMeans(unsexed_df)
# 4. Create long-format data frame for sexed
sexed_df_long <- data.frame(
class_sex = names(sexed_means),
value = as.numeric(sexed_means)
) %>%
separate(class_sex, into = c("class", "sex"), sep = "_")
# 5. Create long-format data frame for unsexed, with sex = "U"
unsexed_df_long <- data.frame(
class = names(unsexed_means),
value = as.numeric(unsexed_means),
sex = "U"
)
# 6. Combine both
means_df <- bind_rows(sexed_df_long, unsexed_df_long)
# 7. Set class as factor to preserve desired order
means_df$class <- factor(means_df$class, levels = x_labels_vec)
# 8. Pivot to wide format for barplot
means_mat <- means_df %>%
pivot_wider(names_from = sex, values_from = value, values_fill = 0) %>%
arrange(class) %>%
select(any_of(c("f", "m", "U")))  # Ensure consistent column order
# 9. Transpose to matrix for barplot (rows = sex, columns = classes)
mat <- t(as.matrix(means_mat))
# 10. Draw barplot
barplot(mat,
col = cols[rownames(mat)],
main = paste('F & M - Q', q, '2015'),
names.arg = x_labels_vec,
las = 1,
cex.main = 2,
cex.axis = 1.5,
cex.names = 1.5,
# ylim = c(0, max(colSums(mat)) * 1.1),
width = width_vector_all,
space = 0,
beside = FALSE,
legend.text = rownames(mat),
args.legend = list(x = "topright", bty = "n", inset = 0.02, cex = 1)
)
}
lopt = function(l_pred){
l = log(l_pred)
r=-1.65
gamma = 0.011
return(r + l - gamma*l^2)
}
ingestion_kernel = function(I_max, l){
l_opt = lopt(l)
return(I_max*exp(-3/2*(log(l)-l_opt)^2))
}
cod_lRange = seq(2.5, 120, 0.1) #[cm]
cod_larvRange = seq(2.5, 3, 0.01) #[cm]
shrimp_lRange = seq(0.155, 8.5, 0.0071) #(8.5-0.15)/1176 steps to meet same length as cod L range
plot(cod_lRange, exp(lopt(cod_lRange)), main = 'Optimal prey lenght of cod', xlab= 'Cod L [cm]',
ylab = 'prey l [cm]' , col = 'gray41', las = 1, cex.axis=1.5, cex.lab=1.5)#, cex.main=1.3, xlim = c(1,4), ylim = c(0,2))
abline(h=0.2, lty= 2, col = 'lightsalmon', lwd=2)
abline(h=8.5, lty=2, col='tomato3', lwd = 2)
legend("topleft", c('l_opt', 'min l BS', 'max l BS') ,col=c('gray41','lightsalmon', 'tomato3'),
lty = c(1,2,2), lwd=2)
Imax = 10
plot(cod_lRange, ingestion_kernel(I_max = Imax, shrimp_lRange), main = paste("Imax=", Imax),
xlab= 'Cod size range [cm]', ylab = 'ingestion kernel')#, xlim= c(0,20))
plot(cod_larvRange, ingestion_kernel(I_max = Imax, cod_larvRange), main = paste("Imax=", Imax),
xlab= 'Cod size range [cm]', ylab = 'ingestion kernel')#, xlim= c(0,20))
test = ingestion_kernel(I_max = Imax, cod_larvRange)
test
cod_avg = (2.5+3)/2
l_opt_cod_avg = lopt(cod_avg)
l_opt_cod_avg
ingestion_kernel_c = function(I_max, l_prey){
l_opt = -0.6496558
return(I_max*exp(-3/2*(log(l_prey)-l_opt)^2))
}
plot(cod_larvRange, ingestion_kernel_c(I_max = Imax, cod_larvRange), main = paste("Imax=", Imax),
xlab= 'Cod size range [cm]', ylab = 'ingestion kernel')
#first see range of l_opt for larval cods:
range_lopt_larvCod = exp(lopt(cod_larvRange))
min(range_lopt_larvCod)
max(range_lopt_larvCod)
shrimp_larv = seq(min(range_lopt_larvCod), max(range_lopt_larvCod), length.out = length(cod_larvRange))
shrimp_larv
shrimpLarv_range = seq(min(range_lopt_larvCod), max(range_lopt_larvCod), length.out = length(cod_larvRange))
plot(cod_larvRange, ingestion_kernel_c(I_max = Imax, cod_larvRange), main = paste("Imax=", Imax),
xlab= 'Cod size range [cm]', ylab = 'ingestion kernel')
plot(cod_larvRange, ingestion_kernel_c(I_max = Imax, shrimpLarv_range), main = paste("Imax=", Imax),
xlab= 'Cod size range [cm]', ylab = 'ingestion kernel')
plot(cod_larvRange, ingestion_kernel_c(I_max = Imax, shrimpLarv_range), main = paste("Imax=", 1),
xlab= 'Cod size range [cm]', ylab = 'ingestion kernel')
Imax=1
plot(cod_larvRange, ingestion_kernel_c(I_max = Imax, shrimpLarv_range), main = paste("Imax=", Imax),
xlab= 'Cod size range [cm]', ylab = 'ingestion kernel')
ingestion_kernel_c(I_max = Imax, 0.3)
ingestion_kernel_c(I_max = Imax, 01)
ingestion_kernel_c(I_max = Imax, 5)
ingestion_kernel_c(I_max = Imax, 0.3)
Bcod = function(t) {
toReturn = 0.2 * (1.2 + cos( (2*pi/ 365)*(t-105) ) )
return(toReturn)
}
t = seq(1,365*5)
plot(t, Bcod(t))
Bcod = function(t) {
toReturn = 0.2 * (1.05 + cos( (2*pi/ 365)*(t-105) ) )
return(toReturn)
}
t = seq(1,365*5)
plot(t, Bcod(t))
devtools::load_all(".")
#following has been adapted according to references found for some life stages in literature:
#has dimention [kg/ 1000m2]
state_rev2 = c(P = 2, E = 0.1, L= 0.0928 *1.5 ,
J_f = 2, J2_f = 2, J3_f = 2 , J4_f = 1.8, J5_f = 1.8,
J_m = 2 , J2_m = 2, J3_m = 2, J4_m = 1.8, J5_m = 1.8,
A1_f = 5.443*0.5, A1_m = 5.443*0.5,
A2 = 5.443*0.375, A3=5.443*0.125, #males doesn't reach this size classes
Pred = 0.05 )
#Ref: Larv: 0.0928 kg/1000m2 but lets say that wihtout predation this is 50% bigger
#Ref Fem: 5.443 kg/1000m2 has to be distributed over the 3 Fem adult size classes: we know that A1 > A2 > A3 in biomass
#therefore lets consider following ratio: A1: 0.5, A2: 0.375, A3: 0.125
#since numbers are bigger now, increase juveniles
t_5years = seq(0,length(temperature_10_14$temperature)-0.1, by = 0.1)
#HERE SIMULATIONS WITH NEW K-FUNC tpc FLEXBRIERE
library(ggplot2)
library(deSolve)
library(RColorBrewer)
library(BrownShrimp)
library(viridis)
library(dplyr)
library(tidyr)
library("colorspace")
#library(devtools)
#UPLOAD TEMPERATURE DATA
temperature_dataSet <- read.csv("./data/Temperature_data_1982-2018_MarBiol.csv", header = TRUE, sep = ';')
temperature_10_11 <- temperature_func(temperature_dataSet, "01/01/2010", "31/12/2011")
temperature_10_14 <- temperature_func(temperature_dataSet, "01/01/2010", "31/12/2014")
t_5years = seq(0,length(temperature_10_14$temperature)-0.1, by = 0.1)
parameters = parameters_solv
#Test with state2
#start <- Sys.time()
#test_sex.v2 <- solver_sizeClass_sex.v2(t = t_5years, state = state2, parameters = parameters, temperature_dataSet = temperature_10_14)
#print(Sys.time() - start)
#TEST WITH state_rev1
#Test with state2
temperature_14_18 <- temperature_func(temperature_dataSet, "01/01/2014", "31/12/2018")
start <- Sys.time()
test_sex.v3 <- solver_sizeClass_sex.v3(t = t_5years, state = state_rev2, parameters = parameters, temperature_dataSet = temperature_14_18)
print(Sys.time() - start)
devtools::load_all(".")
start <- Sys.time()
test_sex.v3 <- solver_sizeClass_sex.v3(t = t_5years, state = state_rev2, parameters = parameters, temperature_dataSet = temperature_14_18)
print(Sys.time() - start)
devtools::load_all(".")
#HERE SIMULATIONS WITH NEW K-FUNC tpc FLEXBRIERE
library(ggplot2)
library(deSolve)
library(RColorBrewer)
library(BrownShrimp)
library(viridis)
library(dplyr)
library(tidyr)
library("colorspace")
#library(devtools)
#UPLOAD TEMPERATURE DATA
temperature_dataSet <- read.csv("./data/Temperature_data_1982-2018_MarBiol.csv", header = TRUE, sep = ';')
temperature_10_11 <- temperature_func(temperature_dataSet, "01/01/2010", "31/12/2011")
temperature_10_14 <- temperature_func(temperature_dataSet, "01/01/2010", "31/12/2014")
state_rev2 = c(P = 2, E = 0.1, L= 0.0928 *1.5 ,
J_f = 2, J2_f = 2, J3_f = 2 , J4_f = 1.8, J5_f = 1.8,
J_m = 2 , J2_m = 2, J3_m = 2, J4_m = 1.8, J5_m = 1.8,
A1_f = 5.443*0.5, A1_m = 5.443*0.5,
A2 = 5.443*0.375, A3=5.443*0.125, #males doesn't reach this size classes
Pred = 0.05 )
#Ref: Larv: 0.0928 kg/1000m2 but lets say that wihtout predation this is 50% bigger
#Ref Fem: 5.443 kg/1000m2 has to be distributed over the 3 Fem adult size classes: we know that A1 > A2 > A3 in biomass
#therefore lets consider following ratio: A1: 0.5, A2: 0.375, A3: 0.125
#since numbers are bigger now, increase juveniles
t_5years = seq(0,length(temperature_10_14$temperature)-0.1, by = 0.1)
parameters = parameters_solv
#Test with state2
#start <- Sys.time()
#test_sex.v2 <- solver_sizeClass_sex.v2(t = t_5years, state = state2, parameters = parameters, temperature_dataSet = temperature_10_14)
#print(Sys.time() - start)
#TEST WITH state_rev1
#Test with state2
temperature_14_18 <- temperature_func(temperature_dataSet, "01/01/2014", "31/12/2018")
start <- Sys.time()
test_sex.v3 <- solver_sizeClass_sex.v3(t = t_5years, state = state_rev2, parameters = parameters, temperature_dataSet = temperature_14_18)
print(Sys.time() - start)
ingestion_kernel(1)
ingestion_kernel(1, 0.5)
devtools::load_all(".")
ingestion_kernel(1)
devtools::load_all(".")
start <- Sys.time()
test_sex.v3 <- solver_sizeClass_sex.v3(t = t_5years, state = state_rev2, parameters = parameters, temperature_dataSet = temperature_14_18)
print(Sys.time() - start)
start_date <- as.POSIXct("2014-01-01", format="%Y-%m-%d", tz = "UTC")
test_sex.v3 <- mutate(test_sex.v3, dateTime = start_date + test_sex.v3$time * 86400) #86400 seconds in one day
test_sex.v3 <- test_sex.v3[ , -1] # delete timesteps column
test_sex_long <- test_sex.v3 %>%
pivot_longer(-dateTime, names_to = "variable", values_to = "value")
#dev.off()
ggplot(test_sex_long, aes(x = dateTime, y = value, color = variable)) +
geom_line(size = 1) +  # Plot lines
labs(title = " TPC-sex F and M \n 2014-2018", x = "Days", y = "Biomass") +
scale_color_manual(
values = c( "P" = "#d9f0a3", "E"= "#1c9099" ,"L" = "gray"  ,
"J_f" = "#8856a7", "J2_f" = "#8856a7", "J3_f" = "#8856a7", "J4_f" = "#8856a7", "J5_f" = "#8856a7",
"J_m" = "#9ebcda", "J2_m" = "#9ebcda", "J3_m" = "#9ebcda", "J4_m" = "#9ebcda", "J5_m" = "#9ebcda",
"A1_f" = "#fd8d3c" , "A1_m" = "maroon4" ,
"A2" = "#e6550d" , "A3" = 'red2')) +
theme_minimal() +
theme(plot.title = element_text(hjust = 0.5), # Center title
axis.title.x = element_text(size = 16),
axis.title.y = element_text(size = 16),
legend.position="bottom")
devtools::load_all(".")
start <- Sys.time()
test_sex.v3 <- solver_sizeClass_sex.v3(t = t_5years, state = state_rev2, parameters = parameters, temperature_dataSet = temperature_14_18)
print(Sys.time() - start)
start_date <- as.POSIXct("2014-01-01", format="%Y-%m-%d", tz = "UTC")
test_sex.v3 <- mutate(test_sex.v3, dateTime = start_date + test_sex.v3$time * 86400) #86400 seconds in one day
test_sex.v3 <- test_sex.v3[ , -1] # delete timesteps column
test_sex_long <- test_sex.v3 %>%
pivot_longer(-dateTime, names_to = "variable", values_to = "value")
#dev.off()
ggplot(test_sex_long, aes(x = dateTime, y = value, color = variable)) +
geom_line(size = 1) +  # Plot lines
labs(title = " TPC-sex F and M \n 2014-2018", x = "Days", y = "Biomass") +
scale_color_manual(
values = c( "P" = "#d9f0a3", "E"= "#1c9099" ,"L" = "gray"  ,
"J_f" = "#8856a7", "J2_f" = "#8856a7", "J3_f" = "#8856a7", "J4_f" = "#8856a7", "J5_f" = "#8856a7",
"J_m" = "#9ebcda", "J2_m" = "#9ebcda", "J3_m" = "#9ebcda", "J4_m" = "#9ebcda", "J5_m" = "#9ebcda",
"A1_f" = "#fd8d3c" , "A1_m" = "maroon4" ,
"A2" = "#e6550d" , "A3" = 'red2')) +
theme_minimal() +
theme(plot.title = element_text(hjust = 0.5), # Center title
axis.title.x = element_text(size = 16),
axis.title.y = element_text(size = 16),
legend.position="bottom")
ggplot(test_sex_long, aes(x = dateTime, y = value, color = variable)) +
geom_line(size = 1) +  # Plot lines
labs(title = " TPC-sex F and M \n 2014-2018", x = "Days", y = "Biomass") +
scale_color_manual(
values = c( "P" = "#d9f0a3", "E"= "#1c9099" ,"L" = "gray"  ,
"J_f" = "#8856a7", "J2_f" = "#8856a7", "J3_f" = "#8856a7", "J4_f" = "#8856a7", "J5_f" = "#8856a7",
"J_m" = "#9ebcda", "J2_m" = "#9ebcda", "J3_m" = "#9ebcda", "J4_m" = "#9ebcda", "J5_m" = "#9ebcda",
"A1_f" = "#fd8d3c" , "A1_m" = "maroon4" ,
"A2" = "#e6550d" , "A3" = 'maroon1', "Pred" = 'red2' )) +
theme_minimal() +
theme(plot.title = element_text(hjust = 0.5), # Center title
axis.title.x = element_text(size = 16),
axis.title.y = element_text(size = 16),
legend.position="bottom")
M_F_2015 = test_sex.v3 %>%
filter( as.Date(dateTime) > as.Date("31/12/2014", format= "%d/%m/%Y" ) & as.Date(dateTime) < as.Date("01/01/2016", format= "%d/%m/%Y" )  ) %>%
select(E, L, J_f, J2_f, J3_f, J4_f, J5_f, A1_f, J_m, J2_m, J3_m, J4_m, J5_m, A1_m, A2, A3)
# Loop through 4 quarters
par(mfrow = c(2, 2))
# Define colors for each sex: f = light blue, m = steel blue, U = gray
cols <- c("f" = "#8856a7", "m" = "#add8e6", "U" = "gray80")
# Define x-axis label order (class names)
x_labels_vec <- c("E", "L", "J", "J2", "J3", "J4", "J5", "A1", "A2", "A3")
width_vector_all <- rep(1, length(x_labels_vec))  # Optional bar widths
# Loop through 4 quarters
for (q in 1:4) {
# Indices for each quarter
init_idx <- 912 * (q - 1) + 1
final_idx <- 912 * q
# Subset data for quarter
quarter_data <- M_F_2015[init_idx:final_idx, ]
# 1. Get sexed class columns (e.g., J_f, J2_m, A1_f, etc.)
sexed_df <- quarter_data %>%
select(matches("^(J|A1)\\d?_f$|^(J|A1)\\d?_m$"))
# 2. Get unsexed class columns: E and L
unsexed_df <- quarter_data %>%
select(E, L, A2, A3)
# 3. Compute column means
sexed_means <- colMeans(sexed_df)
unsexed_means <- colMeans(unsexed_df)
# 4. Create long-format data frame for sexed
sexed_df_long <- data.frame(
class_sex = names(sexed_means),
value = as.numeric(sexed_means)
) %>%
separate(class_sex, into = c("class", "sex"), sep = "_")
# 5. Create long-format data frame for unsexed, with sex = "U"
unsexed_df_long <- data.frame(
class = names(unsexed_means),
value = as.numeric(unsexed_means),
sex = "U"
)
# 6. Combine both
means_df <- bind_rows(sexed_df_long, unsexed_df_long)
# 7. Set class as factor to preserve desired order
means_df$class <- factor(means_df$class, levels = x_labels_vec)
# 8. Pivot to wide format for barplot
means_mat <- means_df %>%
pivot_wider(names_from = sex, values_from = value, values_fill = 0) %>%
arrange(class) %>%
select(any_of(c("f", "m", "U")))  # Ensure consistent column order
# 9. Transpose to matrix for barplot (rows = sex, columns = classes)
mat <- t(as.matrix(means_mat))
# 10. Draw barplot
barplot(mat,
col = cols[rownames(mat)],
main = paste('F & M - Q', q, '2015'),
names.arg = x_labels_vec,
las = 1,
cex.main = 2,
cex.axis = 1.5,
cex.names = 1.5,
# ylim = c(0, max(colSums(mat)) * 1.1),
width = width_vector_all,
space = 0,
beside = FALSE,
legend.text = rownames(mat),
args.legend = list(x = "topright", bty = "n", inset = 0.02, cex = 1)
)
}
devtools::load_all(".")
state_rev2 = c(P = 2, E = 0.1, L= 0.0928 *1.5 ,
J_f = 2, J2_f = 2, J3_f = 2 , J4_f = 1.8, J5_f = 1.8,
J_m = 2 , J2_m = 2, J3_m = 2, J4_m = 1.8, J5_m = 1.8,
A1_f = 5.443*0.5, A1_m = 5.443*0.5,
A2 = 5.443*0.375, A3=5.443*0.125, #males doesn't reach this size classes
Pred = 0.05 )
#Ref: Larv: 0.0928 kg/1000m2 but lets say that wihtout predation this is 50% bigger
#Ref Fem: 5.443 kg/1000m2 has to be distributed over the 3 Fem adult size classes: we know that A1 > A2 > A3 in biomass
#therefore lets consider following ratio: A1: 0.5, A2: 0.375, A3: 0.125
#since numbers are bigger now, increase juveniles
t_5years = seq(0,length(temperature_10_14$temperature)-0.1, by = 0.1)
parameters = parameters_solv
#Test with state2
temperature_14_18 <- temperature_func(temperature_dataSet, "01/01/2014", "31/12/2018")
start <- Sys.time()
test_sex.v3 <- solver_sizeClass_sex.v3(t = t_5years, state = state_rev2, parameters = parameters, temperature_dataSet = temperature_14_18)
print(Sys.time() - start)
M_F_2015 = test_sex.v3 %>%
filter( as.Date(dateTime) > as.Date("31/12/2014", format= "%d/%m/%Y" ) & as.Date(dateTime) < as.Date("01/01/2016", format= "%d/%m/%Y" )  ) %>%
select(E, L, J_f, J2_f, J3_f, J4_f, J5_f, A1_f, J_m, J2_m, J3_m, J4_m, J5_m, A1_m, A2, A3)
start_date <- as.POSIXct("2014-01-01", format="%Y-%m-%d", tz = "UTC")
test_sex.v3 <- mutate(test_sex.v3, dateTime = start_date + test_sex.v3$time * 86400) #86400 seconds in one day
test_sex.v3 <- test_sex.v3[ , -1] # delete timesteps column
test_sex_long <- test_sex.v3 %>%
pivot_longer(-dateTime, names_to = "variable", values_to = "value")
#dev.off()
ggplot(test_sex_long, aes(x = dateTime, y = value, color = variable)) +
geom_line(size = 1) +  # Plot lines
labs(title = " TPC-sex F and M \n 2014-2018", x = "Days", y = "Biomass") +
scale_color_manual(
values = c( "P" = "#d9f0a3", "E"= "#1c9099" ,"L" = "gray"  ,
"J_f" = "#8856a7", "J2_f" = "#8856a7", "J3_f" = "#8856a7", "J4_f" = "#8856a7", "J5_f" = "#8856a7",
"J_m" = "#9ebcda", "J2_m" = "#9ebcda", "J3_m" = "#9ebcda", "J4_m" = "#9ebcda", "J5_m" = "#9ebcda",
"A1_f" = "#fd8d3c" , "A1_m" = "maroon4" ,
"A2" = "#e6550d" , "A3" = 'maroon1', "Pred" = 'red2' )) +
theme_minimal() +
theme(plot.title = element_text(hjust = 0.5), # Center title
axis.title.x = element_text(size = 16),
axis.title.y = element_text(size = 16),
legend.position="bottom")
M_F_2015 = test_sex.v3 %>%
filter( as.Date(dateTime) > as.Date("31/12/2014", format= "%d/%m/%Y" ) & as.Date(dateTime) < as.Date("01/01/2016", format= "%d/%m/%Y" )  ) %>%
select(E, L, J_f, J2_f, J3_f, J4_f, J5_f, A1_f, J_m, J2_m, J3_m, J4_m, J5_m, A1_m, A2, A3)
# Loop through 4 quarters
par(mfrow = c(2, 2))
# Define colors for each sex: f = light blue, m = steel blue, U = gray
cols <- c("f" = "#8856a7", "m" = "#add8e6", "U" = "gray80")
# Define x-axis label order (class names)
x_labels_vec <- c("E", "L", "J", "J2", "J3", "J4", "J5", "A1", "A2", "A3")
width_vector_all <- rep(1, length(x_labels_vec))  # Optional bar widths
# Loop through 4 quarters
for (q in 1:4) {
# Indices for each quarter
init_idx <- 912 * (q - 1) + 1
final_idx <- 912 * q
# Subset data for quarter
quarter_data <- M_F_2015[init_idx:final_idx, ]
# 1. Get sexed class columns (e.g., J_f, J2_m, A1_f, etc.)
sexed_df <- quarter_data %>%
select(matches("^(J|A1)\\d?_f$|^(J|A1)\\d?_m$"))
# 2. Get unsexed class columns: E and L
unsexed_df <- quarter_data %>%
select(E, L, A2, A3)
# 3. Compute column means
sexed_means <- colMeans(sexed_df)
unsexed_means <- colMeans(unsexed_df)
# 4. Create long-format data frame for sexed
sexed_df_long <- data.frame(
class_sex = names(sexed_means),
value = as.numeric(sexed_means)
) %>%
separate(class_sex, into = c("class", "sex"), sep = "_")
# 5. Create long-format data frame for unsexed, with sex = "U"
unsexed_df_long <- data.frame(
class = names(unsexed_means),
value = as.numeric(unsexed_means),
sex = "U"
)
# 6. Combine both
means_df <- bind_rows(sexed_df_long, unsexed_df_long)
# 7. Set class as factor to preserve desired order
means_df$class <- factor(means_df$class, levels = x_labels_vec)
# 8. Pivot to wide format for barplot
means_mat <- means_df %>%
pivot_wider(names_from = sex, values_from = value, values_fill = 0) %>%
arrange(class) %>%
select(any_of(c("f", "m", "U")))  # Ensure consistent column order
# 9. Transpose to matrix for barplot (rows = sex, columns = classes)
mat <- t(as.matrix(means_mat))
# 10. Draw barplot
barplot(mat,
col = cols[rownames(mat)],
main = paste('F & M - Q', q, '2015'),
names.arg = x_labels_vec,
las = 1,
cex.main = 2,
cex.axis = 1.5,
cex.names = 1.5,
# ylim = c(0, max(colSums(mat)) * 1.1),
width = width_vector_all,
space = 0,
beside = FALSE,
legend.text = rownames(mat),
args.legend = list(x = "topright", bty = "n", inset = 0.02, cex = 1)
)
}
